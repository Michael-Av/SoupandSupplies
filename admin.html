<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Free-Finding | Admin Approval</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #admin-content { display: none; }
        #login-container { height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body class="bg-light">

    <div id="login-container">
        <h2 class="mb-4">Admin Access</h2>
        <button id="loginBtn" class="btn btn-primary btn-lg">Sign in with Google</button>
        <p class="mt-3 text-muted">Only authorized accounts can access this panel.</p>
    </div>

    <div id="admin-content" class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Pending Submissions</h1>
            <div>
                <span id="userEmail" class="me-3 text-muted"></span>
                <button id="logoutBtn" class="btn btn-sm btn-outline-danger">Logout</button>
            </div>
        </div>
        
        <div id="submissions-list" class="row g-3">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p>Loading submissions...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCaWxIZZbKzdhbwgDLpSuZkwGcKjel38A4",
            authDomain: "soupandsupplies.firebaseapp.com",
            projectId: "soupandsupplies",
            storageBucket: "soupandsupplies.firebasestorage.app",
            messagingSenderId: "133184291298",
            appId: "1:133184291298:web:c64e1fa6806bae9ff2f9bb",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // UI Elements
        const loginContainer = document.getElementById('login-container');
        const adminContent = document.getElementById('admin-content');
        const userEmailSpan = document.getElementById('userEmail');

        // Check Auth State
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // You can add an extra check here for your specific email
                if (user.email !== "mavrahami29@gmail.com") { signOut(auth); alert("Unauthorized"); return; }
                
                loginContainer.style.display = 'none';
                adminContent.style.display = 'block';
                userEmailSpan.textContent = user.email;
                loadSubmissions();
            } else {
                loginContainer.style.display = 'flex';
                adminContent.style.display = 'none';
            }
        });

        document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
        document.getElementById('logoutBtn').onclick = () => signOut(auth);

        async function loadSubmissions() {
            const container = document.getElementById('submissions-list');
            container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
            
            try {
                const snapshot = await getDocs(collection(db, "submissions"));
                container.innerHTML = '';
                
                if (snapshot.empty) {
                    container.innerHTML = '<div class="alert alert-info">No pending submissions!</div>';
                    return;
                }

                snapshot.forEach((submissionDoc) => {
                    const data = submissionDoc.data();
                    const id = submissionDoc.id;
                    const card = document.createElement('div');
                    card.className = 'col-md-6';
                    card.innerHTML = `
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title d-flex justify-content-between">
                                    ${data.name} 
                                    <span class="badge bg-primary fs-6">${data.type}</span>
                                </h5>
                                <p class="mb-1 text-muted small"><strong>Address:</strong> ${data.address}</p>
                                <p class="mb-2"><strong>Description:</strong> ${data.desc}</p>
                                <hr>
                                <p class="mb-3 text-muted small"><strong>Source:</strong> ${data.source}</p>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success flex-grow-1" onclick="approve('${id}')">Approve</button>
                                    <button class="btn btn-outline-danger" onclick="reject('${id}')">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (e) {
                container.innerHTML = `<div class="alert alert-danger">Permission Denied. Ensure your email is authorized in Firestore Rules.</div>`;
            }
        }

        window.approve = async (id) => {
            if (!confirm("Approve this resource?")) return;
            try {
                const snapshot = await getDocs(collection(db, "submissions"));
                const subData = snapshot.docs.find(d => d.id === id).data();
                
                await addDoc(collection(db, "resources"), { ...subData, isApproved: true, approvedAt: new Date() });
                await deleteDoc(doc(db, "submissions", id));
                loadSubmissions();
            } catch (e) { alert("Error: " + e.message); }
        };

        window.reject = async (id) => {
            if (confirm("Delete submission?")) {
                await deleteDoc(doc(db, "submissions", id));
                loadSubmissions();
            }
        };
    </script>
</body>
</html>
